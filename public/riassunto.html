<!DOCTYPE html>
<html>
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Crea Squadra - Fanteex</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,800;1,800&family=Barlow+Condensed:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/mobile2.css">
  
  <!-- Rimuovi il riferimento a auth.js qui -->
  <script src="/js/avatar-functions.js"></script>
<script>
    // Script per recuperare i dati dal localStorage o dall'URL
    document.addEventListener("DOMContentLoaded", () => {
      try {
        // Verifica se ci sono parametri nell'URL
        const params = new URLSearchParams(window.location.search);
        const contestId = params.get("contest");
        const opponentId = params.get("opponent");
        const ownerId = params.get("owner");
        const userId = params.get("user");
        const aepId = params.get("aep_id"); // Aggiungi il parametro aep_id
        
        // Se ci sono parametri nell'URL, salvali nel localStorage e reindirizza alla pagina senza parametri
        if (contestId || opponentId || ownerId || userId || aepId) {
          // Salva i parametri nel localStorage
          const contestData = {
            contestId: contestId || "",  // Usa stringa vuota invece di null
            opponentId: opponentId || "",
            ownerId: ownerId || "",
            userId: userId || "",
            aepId: aepId || "",  // Salva aep_id nel localStorage
            timestamp: new Date().getTime()
          };
          localStorage.setItem('contestData', JSON.stringify(contestData));
          
          // Reindirizza alla pagina senza parametri
          window.history.replaceState({}, document.title, '/riassunto.html');
          
          // Imposta i dati come variabili globali solo se non sono null
          if (contestId) window.contestId = contestId;
          if (opponentId) window.opponentId = opponentId;
          if (ownerId) window.ownerId = ownerId;
          if (userId) window.userId = userId;
          if (aepId) window.aepId = aepId; // Imposta aep_id come variabile globale
          
          // Imposta il flag contestDataReady a true
          window.contestDataReady = true;
          
          return; // Esci dalla funzione
        }
        
        // Recupera i dati dal localStorage
        const contestDataStr = localStorage.getItem('contestData');
        
        // Se abbiamo dati nel localStorage, usiamo quelli
        if (contestDataStr) {
          const contestData = JSON.parse(contestDataStr);
          
          // Verifica che i dati non siano troppo vecchi (opzionale, per sicurezza)
          const now = new Date().getTime();
          const dataAge = now - contestData.timestamp;
          const maxAge = 5 * 60 * 1000; // 5 minuti in millisecondi
          
          if (dataAge > maxAge) {
            localStorage.removeItem('contestData'); // Pulisci i dati scaduti
            window.location.href = '/user-landing.html';
            return;
          } else {
            // Imposta i dati come variabili globali per essere utilizzati dal modulo riassunto.js
            window.contestId = contestData.contestId;
            window.eventUnitId = contestData.event_unit_id || contestData.eventUnitId;
            window.opponentId = contestData.opponentId;
            window.ownerId = contestData.ownerId;
            window.userId = contestData.userId;
            window.aepId = contestData.aepId; // Imposta aep_id come variabile globale
            
            // Imposta il flag contestDataReady a true
            window.contestDataReady = true;
            
            return; // Esci dalla funzione se abbiamo recuperato i dati dal localStorage
          }
        } else {
          // Se non abbiamo dati né nell'URL né nel localStorage, non mostrare errori
          // ma reindirizza silenziosamente alla pagina user-landing
          window.location.href = '/user-landing.html';
        }
      } catch (e) {
        window.location.href = '/user-landing.html';
      }
    });
    
    // Funzione per salvare l'aep_id quando si conferma la squadra
    function salvaAepId() {
      try {
        // Recupera i giocatori scelti
        const chosenPlayers = JSON.parse(localStorage.getItem('chosenPlayers') || '[]');
        
        // Recupera l'aep_id globale
        const aepId = window.aepId;
        
        // Recupera i dati dal localStorage
        const contestDataStr = localStorage.getItem('contestData');
        
        if (contestDataStr) {
          const contestData = JSON.parse(contestDataStr);
          
          // Verifica se abbiamo un aep_id nei dati del contest
          if (contestData.aepId) {
            // Aggiungi l'aep_id a tutti i giocatori che non lo hanno già
            const playersConAepId = chosenPlayers.map(player => {
              if (player.aep_id) {
                return player;
              }
              return { ...player, aep_id: contestData.aepId };
            });
            
            // Salva i giocatori aggiornati
            localStorage.setItem('chosenPlayers', JSON.stringify(playersConAepId));
            return true;
          }
        }
        
        // Se non abbiamo trovato un aep_id nei dati del contest, usiamo quello globale
        if (aepId) {
          // Aggiungi l'aep_id a tutti i giocatori che non lo hanno già
          const playersConAepId = chosenPlayers.map(player => {
            if (player.aep_id) {
              return player;
            }
            return { ...player, aep_id: aepId };
          });
          
          // Salva i giocatori aggiornati
          localStorage.setItem('chosenPlayers', JSON.stringify(playersConAepId));
          return true;
        }
        
        return false;
      } catch (e) {
        return false;
      }
    }
  </script>
    
    <!-- Aggiungi gli script di Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Carica auth.js DOPO aver caricato Firebase -->
    <script src="auth.js"></script>
</head>
<body>
  <header class="header">
    <div class="user-profile">
      <img src="icons/freccia.png" alt="Back" id="backArrow" style="width: 30px; height: 30px; cursor: pointer; margin-right: 12px;">
      <div class="user-info">
        <h1 class="user-name">CREATE TEAM</h1>
      </div>
    </div>
    <div class="teex-balance">
         <img src="icons/ppc.png" alt="Teex" class="teex-icon">
      <span id="teexBalance" class="teex_balance">0.0</span>
    </div>
  </header>
  <div class="contest-container cc-header" id="contestHeaderContainer"></div>
  </div>
  <div class="budget-bar">
    <img src="icons/ppc.png" alt="Teex" class="teex-left-icon">
    <span id="teexLeft"><span class="teex-left-text-cyan">10.0</span> <span class="teex-left-text-white">Papa Coins left</span></span>
  </div>
  <div id="messaggio" style="display: none;"></div>
  <div id="userNameDiv" style="display: none;"></div>
  <div id="teamCostDiv" style="display: none;"></div>
  <div id="budgetInfo" style="display: none;"></div>
  <div id="errorMessage" style="display: none; color: red; text-align: center; margin: 10px 0; font-weight: bold;"></div>
  <section class="teams-section">
    <div class="team-container one-team" style="width: 100%;">
      <div class="team-list" id="playersList"></div>
    </div>
  </section>
  <ul id="playerList" style="display: none;"></ul>
  <div class="fab-background"></div>
  <div id="addPlayerBtn" class="fab_button" style="position: fixed; bottom: 96px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; justify-content: center; z-index: 101; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
    <img src="icons/add.png" alt="Add Player" style="width: 24px; height: 24px; margin-right: 8px;">
    <span style="color: #ffffff;">ADD PAPABILI</span>
  </div>
  <footer class="footer-nav" style="justify-content: flex-end;">
    <button id="resetTeamBtn" class="footer_button footer_button_light" disabled>RESET TEAM</button>
    <button id="confirmFooterBtn" class="footer_button fb_unable_orange" disabled>PLAY</button>
  </footer>

  <!-- Carica il modulo riassunto.js DOPO aver impostato le variabili globali -->
  <script type="module" src="./js/riassunto.js"></script>
  
  <!-- Aggiungi questo script per collegare la funzione salvaAepId al pulsante di conferma -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const confirmBtn = document.getElementById('confirmFooterBtn');
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
          // Chiama la funzione per salvare l'aep_id prima di confermare la squadra
          salvaAepId();
        });
      }
    });
  </script>
  
  <!-- Add this right before the closing </body> tag -->
  <div id="multiplyOverlay" class="multiply-overlay" style="display: none;">
    <div class="multiply-container" style="padding-bottom: 96px;">
      <div class="title_centre">
        MULTIPLY YOUR WIN<br>X
      </div>
      <div class="multiply-circles">
        <div class="multiply-circle mc-off" data-multiply="1">1</div>
        <div class="multiply-circle mc-off" data-multiply="5">5</div>
        <div class="multiply-circle mc-off" data-multiply="10">10</div>
      </div>
      <div class="title_centre">TOTAL COST</div>
      <div class="big-cost" id="multipliedCost">0.0</div>
      <!-- Replace the buttons div with a footer -->
      <footer class="footer-nav" style="justify-content: flex-end; margin-top: 48px;">
        <button class="footer_button footer_button_blue" id="cancelMultiply">CANCEL</button>
        <button class="footer_button footer_button_orange" id="confirmMultiply">CONFIRM</button>
      </footer>
    </div>
  </div>
</body>
</html>
