<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>User Landing - Fanteex</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,800;1,800&family=Barlow+Condensed:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <!-- Add mobile-first styles -->
  <style>
    /* Mobile-first styles override */
    body {
      padding-bottom: 70px; /* Space for fixed footer */
    }

    /* Header (User Landing) - Mobile First */
    @media (max-width: 767px) {
      .header {
        flex-direction: row;
        flex-wrap: wrap;
        padding: 12px;
        position: relative;
      }

      .user-info {
        width: 70%;
        margin-bottom: 12px;
      }

      .teex-container {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 6px 10px;
        border-radius: 10px;
      }

      .power-up-section {
        width: 100%;
        gap: 6px;
        margin-top: 6px;
        flex-wrap: wrap;
      }

      .avatar {
        width: 50px;
        height: 50px;
        margin-right: 10px;
      }

      .user-details h1 {
        font-size: 20px;
      }

      .progress-container {
        width: 100%;
        max-width: 200px;
        height: 6px;
        margin-top: 6px;
      }

      /* Rest of the mobile styles remain the same */
    }

    /* Add container for contest lists */
    .contests-container {
      padding-bottom: 80px; /* Extra space at bottom for scrolling past footer */
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="user-info">
      <img id="userAvatar" class="avatar" src="avatars/default.png" alt="User Avatar">
      <div class="user-details">
        <h1 id="userName">USERNAME</h1>
        <div class="progress-container">
          <div class="progress-bar" style="width: 35%;"></div>
        </div>
        <div class="progress-text">35%</div>
        <div class="power-up-section">
          <div class="power-up-item">
            <img src="icons/gem_yellow.png" alt="Yellow Gem" class="power-up-icon">
            <span class="power-up-value">250</span>
            <span class="plus-icon">+</span>
          </div>
          <div class="power-up-item">
            <img src="icons/gem_pink.png" alt="Pink Gem" class="power-up-icon">
            <span class="power-up-value">250</span>
            <span class="plus-icon">+</span>
          </div>
          <div class="power-up-item">
            <img src="icons/coin_green.png" alt="Green Coin" class="power-up-icon">
            <span class="power-up-value">250</span>
            <span class="plus-icon">+</span>
          </div>
        </div>
      </div>
    </div>
    <div class="teex-container">
      <img src="icons/teex.png" alt="Teex" class="teex-icon">
      <span id="teexBalance">Teex: ???</span>
    </div>
  </header>

  <div class="tab-container">
    <div id="tabActive" class="tab active">ATTIVE</div>
    <div id="tabCompleted" class="tab">CONCLUSE</div>
  </div>

  <div id="activeContainer" class="contests-container"></div>
  <div id="completedContainer" class="contests-container" style="display: none;"></div>

  <footer class="footer-nav">
    <div class="footer-item">
      <img src="icons/leaderboard.png" alt="Leaderboard" class="footer-icon">
      <span class="footer-label">Leaderboard</span>
    </div>
    <div class="footer-item">
      <img src="icons/badges.png" alt="Badges" class="footer-icon">
      <span class="footer-label">Badges</span>
    </div>
    <div class="footer-item play" id="playButton">
      <div class="play-circle">
        <span class="plus-symbol">+</span>
        <span class="play-text">PLAY</span>
      </div>
    </div>
    <div class="footer-item">
      <img src="icons/statistics.png" alt="Statistics" class="footer-icon">
      <span class="footer-label">Statistics</span>
    </div>
    <div class="footer-item">
      <img src="icons/friends.png" alt="Friends" class="footer-icon">
      <span class="footer-label">Friends</span>
    </div>
  </footer>

  <style>
    /* Stile per il nuovo pulsante PLAY */
    .play-circle {
      width: 60px;
      height: 60px;
      background-color: #00F2FF;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    
    .plus-symbol {
      font-size: 24px;
      font-weight: bold;
      color: #131A47;
      line-height: 1;
    }
    
    .play-text {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 16px;
      font-weight: bold;
      color: #131A47;
      line-height: 1;
    }
    
    /* Modifica per la classe .footer-item.play */
    .footer-item.play {
      background-color: transparent; /* Rimuove il background */
      border-radius: 0; /* Rimuove il border-radius */
      padding: 0; /* Rimuove il padding */
      margin-top: -20px; /* Mantiene il posizionamento verso l'alto */
    }
    
    /* Rimuovo lo stile del vecchio pulsante */
    .create-challenge-btn {
      display: none;
    }
    
    /* Aggiusto la barra di navigazione */
    .footer-nav {
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      background-color: #0B0C2A;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
  </style>

  <script>

        function getAvatarSrc(avatar) {
          if (avatar) {
            if (avatar.startsWith("http")) {
              // Per gli URL di Google, assicuriamoci che non ci siano problemi di encoding
              if (avatar.includes("googleusercontent.com")) {
                // Decodifica l'URL per assicurarsi che non ci siano problemi di encoding
                return decodeURIComponent(avatar);
              }
              return avatar;
            } else {
              return "avatars/" + avatar;
            }
          } else {
            return "avatars/avatar.jpg";
          }
        }




    const params = new URLSearchParams(window.location.search);
  const userId = params.get("user");

  async function loadUserLanding() {
    if (!userId) {
      alert("User mancante!");
      return;
    }
    const resp = await fetch(`/user-landing-info?user=${userId}`);
    const data = await resp.json();

    const userAvatarElem = document.getElementById("userAvatar");
    const avatarSrc = getAvatarSrc(data.user.avatar);
    console.log("Avatar URL:", avatarSrc); // Log per debug
    userAvatarElem.src = avatarSrc;
    userAvatarElem.onerror = function() {
      console.error("Errore caricamento avatar, uso default");
      this.src = "avatars/avatar.jpg";
    };
    document.getElementById("userName").textContent = data.user.username.toUpperCase();
    document.getElementById("teexBalance").textContent = `Teex: ${data.user.teex_balance}`;

    // Render contest list: Usa contest.status_display (già calcolato dal backend)
    renderContestList(data.active, document.getElementById("activeContainer"));
    renderContestList(data.completed, document.getElementById("completedContainer"));
  }


  function renderContestList(list, container) {
    container.innerHTML = "";
    list.forEach(contest => {
      const iAmOwner = (contest.owner_id == userId);
      let myName, myAvatar, myCost, oppName, oppAvatar, oppCost;
      if (iAmOwner) {
        myName = contest.owner_name;
        myAvatar = contest.owner_avatar;
        myCost = contest.owner_cost || "-";
        oppName = contest.opponent_name;
        oppAvatar = contest.opponent_avatar;
        oppCost = contest.opponent_cost || "-";
      } else {
        myName = contest.opponent_name;
        myAvatar = contest.opponent_avatar;
        myCost = contest.opponent_cost || "-";
        oppName = contest.owner_name;
        oppAvatar = contest.owner_avatar;
        oppCost = contest.owner_cost || "-";
      }

      let displayedStatus = contest.status_display;  // valore di default
      let statusClass = "";
      if (contest.status == 1 && !iAmOwner) {
        displayedStatus = "INVITED";
        statusClass = "invited";
      }

      const center = document.createElement("div");
      const statusSpan = document.createElement("span");
      statusSpan.classList.add("contest-status");
      if (statusClass) statusSpan.classList.add(statusClass);
      statusSpan.textContent = displayedStatus;
      const badgeSpan = document.createElement("span");
      badgeSpan.classList.add("badge");
      badgeSpan.textContent = "1";
      center.appendChild(statusSpan);
      center.appendChild(badgeSpan);

      const row1 = document.createElement("div");
      row1.classList.add("row1");
      const left = document.createElement("div");
      left.classList.add("contest-player");
      left.innerHTML = `<img class="contest-avatar" src="${getAvatarSrc(myAvatar)}" alt="${myName}"> <span class="player-name">${myName}</span>`;
      const right = document.createElement("div");
      right.classList.add("contest-player");
      right.innerHTML = `<span class="player-name">${oppName}</span> <img class="contest-avatar" src="${getAvatarSrc(oppAvatar)}" alt="${oppName}">`;
      row1.appendChild(left);
      row1.appendChild(center);
      row1.appendChild(right);

      const row2 = document.createElement("div");
      row2.classList.add("row2");
      row2.innerHTML = `<span class="numeric">${myCost}</span> <span class="numeric stake">${contest.stake || 0}</span> <span class="numeric">${oppCost}</span>`;

      const div = document.createElement("div");
      div.classList.add("contest-cell", "clickable");
      div.appendChild(row1);
      div.appendChild(row2);

      div.addEventListener("click", () => {
        if (contest.status == 1 && !iAmOwner) {
          localStorage.removeItem("chosenPlayers");
          window.location.href = `/riassunto.html?owner=${contest.owner_id}&opponent=${contest.opponent_id}&contest=${contest.contest_id}&user=${userId}`;
        } else {
          window.location.href = `/contest-details.html?contest=${contest.contest_id}&user=${userId}`;
        }
      });

      container.appendChild(div);
    });

    if (!list.length) {
      container.innerHTML = "<p class='no-challenges'>Nessuna sfida</p>";
    }
  }

  function showActive() {
    document.getElementById("tabActive").classList.add("active");
    document.getElementById("tabCompleted").classList.remove("active");
    document.getElementById("activeContainer").style.display = "block";
    document.getElementById("completedContainer").style.display = "none";
  }
  function showCompleted() {
    document.getElementById("tabActive").classList.remove("active");
    document.getElementById("tabCompleted").classList.add("active");
    document.getElementById("activeContainer").style.display = "none";
    document.getElementById("completedContainer").style.display = "block";
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadUserLanding();
    document.getElementById("tabActive").addEventListener("click", showActive);
    document.getElementById("tabCompleted").addEventListener("click", showCompleted);
    
    // Sposto l'event listener dal vecchio pulsante al nuovo pulsante PLAY
    document.getElementById("playButton").addEventListener("click", async () => {
        localStorage.removeItem("chosenPlayers");
        try {
          // Recupera il current event unit
          const resp = await fetch("/current-event-unit");
          if (!resp.ok) {
            throw new Error("Current event unit non trovata");
          }
          const currentUnit = await resp.json();
          // Passa event_unit_id insieme agli altri parametri
          window.location.href = `/scegli-opponent.html?owner=${userId}&user=${userId}&event_unit_id=${currentUnit.event_unit_id}`;
        } catch (error) {
          console.error("Errore nel recupero del current event unit:", error);
          alert("Impossibile recuperare l'unità evento corrente");
        }
    });
  });
  </script>
</body>
</html>
