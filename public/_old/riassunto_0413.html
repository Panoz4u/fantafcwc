<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Crea Squadra - Fanteex</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,800;1,800&family=Barlow+Condensed:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/mobile.css">
  <link rel="stylesheet" href="css/mobile2.css">

</head>
<body>
  <!-- Updated header using mobile.css styles -->
  <header class="header">
    <div class="user-profile">
      <img src="icons/freccia.png" alt="Back" id="backArrow" style="width: 30px; height: 30px; cursor: pointer; margin-right: 12px;">
      <div class="user-info">
        <h1 class="user-name">CREATE TEAM</h1>
      </div>
    </div>
    <div class="teex-balance">
      <img src="icons/more.png" alt="Add" class="plus-icon">
      <img src="icons/teex.png" alt="Teex" class="teex-icon">
      <span id="teexBalance" class="teex_balance">0.0</span>
    </div>
  </header>


  <!-- Contest header container -->
  <div class="contest-container cc-header" id="contestHeaderContainer">
    <!-- Il contest verrà renderizzato qui -->
  </div>



  <!-- Power-up bar -->
  <div class="power-up-section-contest">
    <div class="power-up-items">
      <div class="power-up-item">
        <img src="icons/gem_yellow.png" alt="Yellow Gem" class="power-up-icon">
        <div class="power-up-value-container" id="homeAdvantageBtn" style="cursor: pointer;">
          <span class="power-up-text">Play at home +0.5</span>
        </div>
      </div>
      <div class="power-up-item">
        <img src="icons/gem_pink.png" alt="Pink Gem" class="power-up-icon">
        <div class="power-up-value-container" id="topPlayerCouponBtn" style="cursor: pointer;">
          <span class="power-up-text">Coupon Top Player</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra del budget rimanente -->
  <div class="budget-bar">
    <img src="icons/teex.png" alt="Teex" class="teex-left-icon">
    <span id="teexLeft"><span class="teex-left-text-cyan">20.0</span> <span class="teex-left-text-white">Teex left</span></span>
  </div>


  <!-- Contenuto esistente che verrà modificato nelle prossime fasi -->
  <div id="messaggio" style="display: none;"></div>
  <div id="userNameDiv" style="display: none;"></div>
  <div id="teamCostDiv" style="display: none;"></div>
  <div id="budgetInfo" style="display: none;"></div>

  <!-- Sezione Teams: Lista dei giocatori -->
  <section class="teams-section">
    <!-- Lista Squadra (utente corrente) -->
    <div class="team-container one-team" style="width: 100%;">
      <div class="team-list" id="playersList">
        <!-- I giocatori verranno renderizzati qui -->
      </div>
    </div>
  </section>

  <!-- Rimuovo la cella Add Player e gli elementi non formattati -->
  <ul id="playerList" style="display: none;"></ul>

  <!-- Blur background for FAB -->
  <div class="fab-background"></div>

  <!-- FAB button for Add Player -->
  <div id="addPlayerBtn" class="fab_button" style="position: fixed; bottom: 96px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; justify-content: center; z-index: 101; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
    <img src="icons/add.png" alt="Add Player" style="width: 24px; height: 24px; margin-right: 8px;">
    <span style="color: #ffffff;">ADD PLAYER</span>
  </div>

  <!-- Footer bar with buttons aligned to the right -->
  <footer class="footer-nav" style="justify-content: flex-end;">
    <button id="resetTeamBtn" class="footer_button fb_unable_blu" disabled>RESET TEAM</button>
    <button id="confirmFooterBtn" class="footer_button fb_unable_orange" disabled>CONFIRM</button>
  </footer>

  <script>
    // Script esistente
    async function fetchCurrentEventUnit() {
      try {
        const resp = await fetch("/current-event-unit");
        if (!resp.ok) throw new Error("Errore nel recupero dell'unità evento");
        const unitData = await resp.json();
        return unitData.event_unit_id;
      } catch (error) {
        console.error("fetchCurrentEventUnit:", error);
        return ""; // fallback: valore vuoto
      }
    }
    
    function loadChosenPlayers() {
      const c = localStorage.getItem("chosenPlayers");
      if (!c) return [];
      try { return JSON.parse(c); }
      catch { return []; }
    }
    
    function saveChosenPlayers(list) {
      localStorage.setItem("chosenPlayers", JSON.stringify(list));
    }
    
    function getTotalCost() {
      const pl = loadChosenPlayers();
      return pl.reduce((acc,p)=> acc+parseFloat(p.event_unit_cost||0),0);
    }
    
    function getAvailableBudget() {
      return Math.max(0, 20 - getTotalCost());
    }

    // Aggiungi questa funzione dopo loadChosenPlayers
    async function enrichPlayerData(players) {
      try {
        // Per ogni giocatore, recupera i dati completi dal server se manca il campo picture
        for (let i = 0; i < players.length; i++) {
          if (!players[i].picture) {
            const resp = await fetch(`/athlete-details?id=${players[i].athlete_id}`);
            if (resp.ok) {
              const athleteData = await resp.json();
              // Aggiorna i dati del giocatore con quelli dal server
              players[i].picture = athleteData.picture;
              players[i].athlete_shortname = athleteData.athlete_shortname;
            }
          }
        }
        // Salva i dati aggiornati
        saveChosenPlayers(players);
        return players;
      } catch (error) {
        return players;
      }
    }

    // Modifica la funzione renderPlayerList per aggiornare anche il punteggio dell'utente corrente
    async function renderPlayerList() {
      let players = loadChosenPlayers();
      // Arricchisci i dati dei giocatori
      players = await enrichPlayerData(players);
      
      const ul = document.getElementById("playerList");
      if (ul) ul.innerHTML = "";
      
      // Aggiorna la visualizzazione dei giocatori nella griglia
      const playersContainer = document.querySelector(".players-grid");
      
      // Rimuovi tutti i giocatori esistenti (ma mantieni la cella "Add Player")
      const existingPlayers = document.querySelectorAll(".player-card");
      existingPlayers.forEach(el => el.remove());
      
      // Calcola il costo totale della squadra
      const totalTeamCost = getTotalCost();
      
      // Aggiorna il punteggio dell'utente corrente nell'header
      const currentUserScoreEl = document.getElementById("currentUserScore");
      if (currentUserScoreEl) currentUserScoreEl.textContent = totalTeamCost.toFixed(1);
      
      // Aggiorna i Teex rimasti (20 - costo totale)
      const teexLeft = getAvailableBudget();
      const teexLeftEl = document.getElementById("teexLeft");
      if (teexLeftEl) {
        teexLeftEl.innerHTML = `<span class="teex-left-text-cyan">${teexLeft.toFixed(1)}</span> <span class="teex-left-text-white">Teex left</span>`;
      }
      
      // Aggiorna le classi dei pulsanti CONFIRM e RESET in base alla presenza di giocatori
      const confirmBtn = document.getElementById("confirmFooterBtn");
      const resetBtn = document.getElementById("resetTeamBtn");
      
      if (confirmBtn && resetBtn) {
        const hasPlayers = players.length > 0;
        
        // Aggiorna le classi invece di modificare l'opacità
        if (hasPlayers) {
          confirmBtn.className = "footer_button footer_button_orange";
          resetBtn.className = "footer_button footer_button_blue";
          confirmBtn.disabled = false;
          resetBtn.disabled = false;
        } else {
          confirmBtn.className = "footer_button fb_unable_orange";
          resetBtn.className = "footer_button fb_unable_blu";
          confirmBtn.disabled = true;
          resetBtn.disabled = true;
        }
      }
      
      // Aggiorna la lista dei giocatori nel nuovo formato
      const playersList = document.getElementById("playersList");
      if (playersList) {
        playersList.innerHTML = "";
        
        players.forEach((player, index) => {
          playersList.appendChild(createPlayerRow(player, index));
        });
      }
    }
    
    // Crea una riga per un giocatore nel nuovo formato
    function createPlayerRow(player, index) {
      // Create a wrapper to contain both the player row and the separator
      const wrapper = document.createElement("div");
      
      // Crea il container per la riga
      const row = document.createElement("div");
      row.classList.add("player-row");
      
      // BLOCCO AVATAR: Immagine e posizione
      const avatarBlock = document.createElement("div");
      avatarBlock.classList.add("avatar-block");
      avatarBlock.style.position = "relative";
      
      // Create the athlete avatar container
      const avatarContainer = document.createElement("div");
      avatarContainer.classList.add("atheleteAvatar");
      
      // Create the image inside the container
      const iconImg = document.createElement("img");
      iconImg.src = player.picture ? `pictures/${player.picture}` : `pictures/player_placeholder.png`;
      iconImg.onerror = function() {
        this.src = 'pictures/player_placeholder.png';
      };
      
      // Add the image to the avatar container
      avatarContainer.appendChild(iconImg);
      
      const posCircle = document.createElement("div");
      posCircle.classList.add("position_circle", player.position);
      posCircle.textContent = player.position;
      
      avatarBlock.appendChild(avatarContainer);
      avatarBlock.appendChild(posCircle);
      
      // BLOCCO INFO: Nome e match info
      const infoBlock = document.createElement("div");
      infoBlock.classList.add("player-info");
      
      const nameSpan = document.createElement("div");
      nameSpan.classList.add("athlete_shortname");
      nameSpan.textContent = player.athlete_shortname;
      
      const matchSpan = document.createElement("div");
      matchSpan.classList.add("match_3letter");
      
      if (player.home_team_code && player.away_team_code) {
        // Determina se il giocatore è della squadra di casa o trasferta
        const playerTeamId = parseInt(player.team_id);
        const homeTeamId = parseInt(player.home_team);
        const awayTeamId = parseInt(player.away_team);
        
        const isHomeTeam = playerTeamId === homeTeamId;
        const isAwayTeam = playerTeamId === awayTeamId;
        
        // Crea il testo del match con il team del giocatore in grassetto
        const homeSpan = document.createElement("span");
        homeSpan.textContent = player.home_team_code;
        if (isHomeTeam) homeSpan.classList.add("team-bold");
        
        const dashSpan = document.createElement("span");
        dashSpan.textContent = "-";
        
        const awaySpan = document.createElement("span");
        awaySpan.textContent = player.away_team_code;
        if (isAwayTeam) awaySpan.classList.add("team-bold");
        
        matchSpan.appendChild(homeSpan);
        matchSpan.appendChild(dashSpan);
        matchSpan.appendChild(awaySpan);
      } else {
        matchSpan.textContent = "PARTITA";
      }
      
      infoBlock.appendChild(nameSpan);
      infoBlock.appendChild(matchSpan);
      
      // BLOCCO COSTO
      const costBlock = document.createElement("div");
      costBlock.classList.add("athlete_cost", "ac-long");
      costBlock.textContent = parseFloat(player.event_unit_cost || 0).toFixed(1);
      
      // BLOCCO RIMOZIONE con icona delete.png
      const removeBtn = document.createElement("div");
      removeBtn.classList.add("remove-player-btn");
      
      // Crea l'elemento immagine per l'icona di eliminazione
      const deleteIcon = document.createElement("img");
      deleteIcon.src = "icons/delete.png";
      deleteIcon.alt = "Remove";
      deleteIcon.style.width = "24px";
      deleteIcon.style.height = "24px";
      deleteIcon.style.cursor = "pointer";
      
      // Aggiungi l'evento click per rimuovere il giocatore
      deleteIcon.addEventListener("click", () => {
        removePlayer(index);
      });
      
      // Aggiungi l'icona al pulsante di rimozione
      removeBtn.appendChild(deleteIcon);
      
      // Aggiungi i blocchi alla riga
      row.appendChild(avatarBlock);
      row.appendChild(infoBlock);
      row.appendChild(costBlock);
      row.appendChild(removeBtn);
      
      // Add the row to the wrapper
      wrapper.appendChild(row);
      
      // Add the separator line
      const separator = document.createElement("div");
      separator.classList.add("player-separator");
      wrapper.appendChild(separator);
      
      return wrapper;
    }
    
    // Funzione per rimuovere un giocatore
    function removePlayer(index) {
      const players = loadChosenPlayers();
      players.splice(index, 1);
      saveChosenPlayers(players);
      renderPlayerList();
    }

    // Funzione per ottenere l'URL dell'avatar
    function getAvatarUrl(avatarPath) {
      if (!avatarPath) {
        return "avatars/avatar.jpg"; // Avatar di default
      }
      
      // Controlla se è già un URL completo
      if (avatarPath.startsWith('http://') || avatarPath.startsWith('https://')) {
        return avatarPath;
      }
      
      // Altrimenti è un nome file, aggiungi il percorso avatars/
      return `avatars/${avatarPath}`;
    }

    // Funzione ausiliaria per ottenere la sorgente corretta dell'avatar (come in contest-details.html)
    function getAvatarSrc(avatar) {
      if (avatar) {
        if (avatar.startsWith("http")) {
          // Per gli URL di Google, assicuriamoci che non ci siano problemi di encoding
          if (avatar.includes("googleusercontent.com")) {
            // Decodifica l'URL per assicurarsi che non ci siano problemi di encoding
            return decodeURIComponent(avatar);
          }
          return avatar;
        } else {
          return "avatars/" + avatar;
        }
      } else {
        return "avatars/avatar.jpg";
      }
    }

    // Renderizza l'header del contest usando lo stesso layout di contest-details.html
    function renderContestHeader(contestData) {
      const container = document.getElementById("contestHeaderContainer");
      container.innerHTML = "";
      
      // Determina se il current user è owner
      const params = new URLSearchParams(window.location.search);
      const currentUserId = params.get("user");
      const iAmOwner = (parseInt(currentUserId) === parseInt(contestData.owner_id));
      
      // Calcola il costo totale della squadra attuale
      const totalTeamCost = getTotalCost();
      
      let myName, myAvatar, myCost, oppName, oppAvatar, oppCost;
      if (iAmOwner) {
        myName = contestData.owner_name;
        myAvatar = contestData.owner_avatar;
        myCost = totalTeamCost.toFixed(1); // Usa il costo calcolato dai giocatori scelti
        oppName = contestData.opponent_name;
        oppAvatar = contestData.opponent_avatar;
        oppCost = contestData.opponent_cost || "-";
      } else {
        myName = contestData.opponent_name;
        myAvatar = contestData.opponent_avatar;
        myCost = totalTeamCost.toFixed(1); // Usa il costo calcolato dai giocatori scelti
        oppName = contestData.owner_name;
        oppAvatar = contestData.owner_avatar;
        oppCost = contestData.owner_cost || "-";
      }
      
      // Crea la card del contest
      const contestCard = document.createElement("div");
      contestCard.classList.add("contest-cell");
      
      // Determina il layout in base allo stato del contest
      if (contestData.status == 0 && iAmOwner) {
        // Layout per contest in stato "created" dove sono il proprietario
        contestCard.innerHTML = `
          <div class="ccontest-container cc-header">
            <div class="contest-bar">
              <img src="${getAvatarSrc(myAvatar)}" alt="${myName}" class="player-avatar-contest left-avatar">
              <div class="triletter_contest left-name">${myName.substring(0, 3)}</div>
              <div class="result_bold">VS</div>
              <div class="triletter_contest right-name">${oppName.substring(0, 3)}</div>
              <img src="${getAvatarSrc(oppAvatar)}" alt="${oppName}" class="player-avatar-contest right-avatar">
              <div class="teex_spent left-teex" id="currentUserScore">${myCost}</div>
              <div class="teex_spent right-teex">-</div>
            </div>
            <div class="status-badge-base status-badge">CREATED</div>
          </div>
        `;
      } else if (contestData.status == 1 && iAmOwner) {
        // Layout per contest in stato "pending" dove sono il proprietario
        contestCard.innerHTML = `
          <div class="contest-container cc-header">
            <div class="contest-bar">
              <img src="${getAvatarSrc(myAvatar)}" alt="${myName}" class="player-avatar-contest left-avatar">
              <div class="triletter_contest left-name">${myName.substring(0, 3)}</div>
              <div class="result_bold">VS</div>
              <div class="triletter_contest right-name">${oppName.substring(0, 3)}</div>
              <img src="${getAvatarSrc(oppAvatar)}" alt="${oppName}" class="player-avatar-contest right-avatar">
              <div class="teex_spent left-teex">${myCost}</div>
              <div class="teex_spent right-teex">-</div>
            </div>
            <div class="status-badge-base status-badge">PENDING</div>
          </div>
        `;
      } else if (contestData.status == 1 && !iAmOwner) {
        // Layout per contest in stato "invited" dove sono l'invitato
        contestCard.innerHTML = `
          <div class="contest-container cc-header">
            <div class="contest-bar">
              <img src="${getAvatarSrc(myAvatar)}" alt="${myName}" class="player-avatar-contest left-avatar">
              <div class="triletter_contest left-name">${myName.substring(0, 3)}</div>
              <div class="result_bold">VS</div>
              <div class="triletter_contest right-name">${oppName.substring(0, 3)}</div>
              <img src="${getAvatarSrc(oppAvatar)}" alt="${oppName}" class="player-avatar-contest right-avatar">
              <div class="teex_spent left-teex" id="currentUserScore">${myCost}</div>
              <div class="teex_spent right-teex">${oppCost}</div>
            </div>
            <div class="status-badge-base status-badge-invited">INVITED</div>
          </div>
        `;
      } else if (contestData.status == 2) {
        // Layout per contest in stato "ready"
        contestCard.innerHTML = `
          <div class="contest-container cc-header">
            <div class="contest-bar">
              <img src="${getAvatarSrc(myAvatar)}" alt="${myName}" class="player-avatar-contest left-avatar">
              <div class="triletter_contest left-name">${myName.substring(0, 3)}</div>
              <div class="result_bold">VS</div>
              <div class="triletter_contest right-name">${oppName.substring(0, 3)}</div>
              <img src="${getAvatarSrc(oppAvatar)}" alt="${oppName}" class="player-avatar-contest right-avatar">
              <div class="teex_spent left-teex">${myCost}</div>
              <div class="teex_spent right-teex">${oppCost}</div>
            </div>
            <div class="status-badge-base status-badge-ready">${contestData.stake || ''}</div>
          </div>
        `;
      } else if (contestData.status == 4) {
        // Layout per contest in stato "in progress"
        let leftScore = 0;
        let rightScore = 0;
        
        // Use the result field directly from contestData
        if (contestData.result) {
          const parts = contestData.result.split('-');
          if (parts.length === 2) {
            leftScore = parseFloat(parts[0]) || 0;
            rightScore = parseFloat(parts[1]) || 0;
          }
        }
        
        const leftScoreStr = leftScore.toFixed(1);
        const rightScoreStr = rightScore.toFixed(1);
        
        const [leftScoreInt, leftScoreDec = "0"] = leftScoreStr.split('.');
        const [rightScoreInt, rightScoreDec = "0"] = rightScoreStr.split('.');
        
        contestCard.innerHTML = `
          <div class="contest-container cc-header">
            <div class="contest-bar">
              <img src="${getAvatarSrc(myAvatar)}" alt="${myName}" class="player-avatar-contest left-avatar">
              <div class="triletter_contest left-name">${myName.substring(0, 3)}</div>
              <div style="position: absolute; top: calc(50% - 14px); left: 50%; transform: translate(-50%, -50%); display: flex; align-items: baseline;">
                <span class="result_bold" style="position: static; transform: none; color: #fff">${leftScoreInt}</span>
                <span class="win_index_perc" style="color: #fff">.${leftScoreDec}</span>
                <span style="margin: 0 5px; color: white; font-size: 20px;"> </span>
                <span class="result_bold" style="position: static; transform: none; color: #fff">${rightScoreInt}</span>
                <span class="win_index_perc" style="color: #fff">.${rightScoreDec}</span>
              </div>
              <div class="triletter_contest right-name">${oppName.substring(0, 3)}</div>
              <img src="${getAvatarSrc(oppAvatar)}" alt="${oppName}" class="player-avatar-contest right-avatar">
              <div class="teex_spent left-teex">${myCost}</div>
              <div class="teex_spent right-teex">${oppCost}</div>
            </div>
            <div class="status-badge-base status-badge-live">${contestData.stake || ''}</div>
          </div>
        `;
      } else if (contestData.status == 5) {
        // Layout per contest in stato "completed"
        let leftScore = 0;
        let rightScore = 0;
        let leftWon = false;
        let rightWon = false;
        
        if (contestData.result) {
          const parts = contestData.result.split('-');
          if (parts.length === 2) {
            leftScore = parseFloat(parts[0]) || 0;
            rightScore = parseFloat(parts[1]) || 0;
            leftWon = leftScore > rightScore;
            rightWon = rightScore > leftScore;
          }
        }
        
        const leftScoreStr = leftScore.toFixed(1);
        const rightScoreStr = rightScore.toFixed(1);
        
        const [leftScoreInt, leftScoreDec = "0"] = leftScoreStr.split('.');
        const [rightScoreInt, rightScoreDec = "0"] = rightScoreStr.split('.');
        
        contestCard.innerHTML = `
          <div class="contest-container cc-header">
            <div class="contest-bar">
              <img src="${getAvatarSrc(myAvatar)}" alt="${myName}" class="player-avatar-contest left-avatar ${leftWon ? 'winner-avatar' : ''}">
              <div class="triletter_contest left-name ${leftWon ? 'winner-name' : ''}">${myName.substring(0, 3)}</div>
              <div style="position: absolute; top: calc(50% - 14px); left: 50%; transform: translate(-50%, -50%); display: flex; align-items: baseline;">
                <span class="result_bold" style="position: static; transform: none; color: ${leftWon ? '#0bdad7' : '#fff'}">${leftScoreInt}</span>
                <span class="win_index_perc" style="color: ${leftWon ? '#0bdad7' : '#fff'}">.${leftScoreDec}</span>
                <span style="margin: 0 5px; color: white; font-size: 20px;"> </span>
                <span class="result_bold" style="position: static; transform: none; color: ${rightWon ? '#0bdad7' : '#fff'}">${rightScoreInt}</span>
                <span class="win_index_perc" style="color: ${rightWon ? '#0bdad7' : '#fff'}">.${rightScoreDec}</span>
              </div>
              <div class="triletter_contest right-name ${rightWon ? 'winner-name' : ''}">${oppName.substring(0, 3)}</div>
              <img src="${getAvatarSrc(oppAvatar)}" alt="${oppName}" class="player-avatar-contest right-avatar ${rightWon ? 'winner-avatar' : ''}">
              <div class="teex_spent left-teex">${myCost}</div>
              <div class="teex_spent right-teex">${oppCost}</div>
            </div>
            <div class="status-badge-base status-badge-completed">${contestData.stake || ''}</div>
          </div>
        `;
      } else {
        // Layout di default per altri stati
        contestCard.innerHTML = `
          <div class="contest-container">
            <div class="contest-bar">
              <img src="${getAvatarSrc(myAvatar)}" alt="${myName}" class="player-avatar-contest left-avatar">
              <div class="triletter_contest left-name">${myName.substring(0, 3)}</div>
              <div class="result_bold">VS</div>
              <div class="triletter_contest right-name">${oppName.substring(0, 3)}</div>
              <img src="${getAvatarSrc(oppAvatar)}" alt="${oppName}" class="player-avatar-contest right-avatar">
              <div class="teex_spent left-teex">${myCost}</div>
              <div class="teex_spent right-teex">${oppCost}</div>
            </div>
            <div class="status-badge-base status-badge">${contestData.status_display || 'READY'}</div>
          </div>
        `;
      }
      
      container.appendChild(contestCard);
    }

    async function loadUserInfo(userId, opponentId, ownerId, contestId) {
      try {
        // First, determine who is the current user and who is the opponent
        let currentUserId = userId;
        let actualOpponentId;
        
        // If current user is the opponent in the URL, then the owner is the actual opponent
        if (userId == opponentId) {
          actualOpponentId = ownerId;
        } else {
          actualOpponentId = opponentId;
        }
        
        // Get contest details to get team costs
        const contestResp = await fetch(`/contest-details?contest=${contestId}&user=${userId}`);
        const contestData = await contestResp.json();
        
        // Render contest header
        renderContestHeader(contestData.contest);
        
        // Get all users
        const r = await fetch("/users");
        const allUsers = await r.json();
        
        // Find the current user
        const currentUser = allUsers.find(x => x.user_id == currentUserId);
        if (currentUser) {
          // Update the Teex balance in the header
          document.getElementById("teexBalance").textContent = currentUser.teex_balance.toLocaleString();
          
          // Set current user's team cost
          const isOwner = currentUserId == ownerId;
          
          // Calcola il costo totale della squadra attuale
          const totalTeamCost = getTotalCost();
          
          // Aggiorna i Teex rimasti (20 - costo totale)
          const teexLeft = getAvailableBudget();
          document.getElementById("teexLeft").innerHTML = `<span class="teex-left-text-cyan">${teexLeft.toFixed(1)}</span> <span class="teex-left-text-white">Teex left</span>`;
          
          // These elements might not exist in this page, so wrap them in try/catch
          try {
            document.getElementById("currentUserName").textContent = currentUser.username;
            document.getElementById("currentUserAvatar").src = getAvatarUrl(currentUser.avatar);
            document.getElementById("currentUserScore").textContent = totalTeamCost.toFixed(1);
          } catch (e) {
            console.log("Some elements not found, this is expected");
          }
        }
        
        // Find the actual opponent
        const opponent = allUsers.find(x => x.user_id == actualOpponentId);
        if (opponent) {
          try {
            document.getElementById("opponentName").textContent = opponent.username;
            document.getElementById("opponentAvatar").src = getAvatarUrl(opponent.avatar);
            
            // Set opponent's team cost
            const opponentIsOwner = actualOpponentId == ownerId;
            const opponentCost = opponentIsOwner ? contestData.contest.owner_cost : contestData.contest.opponent_cost;
            document.getElementById("opponentScore").textContent = opponentCost ? parseFloat(opponentCost).toFixed(1) : "-";
          } catch (e) {
            console.log("Some opponent elements not found, this is expected");
          }
        }
      } catch(e) {
        console.error("Errore loadUserInfo", e);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(window.location.search);
      const ownerId = params.get("owner");  // DB info
      const opponentId = params.get("opponent"); // DB info
      const contestId = params.get("contest");
      // UTENTE CORRENTE
      const userIdAttivo = params.get("user"); 
      
      const messaggioEl = document.getElementById("messaggio");
      if (messaggioEl) {
        messaggioEl.textContent = `Contest ID: ${contestId} | userAttivo=${userIdAttivo}`;
      }

      // Add back button event listener
      document.getElementById("backArrow").addEventListener("click", () => {
        history.back();
      });

      // Carica le informazioni degli utenti
      await loadUserInfo(userIdAttivo, opponentId, ownerId, contestId);
      
      // Carica e visualizza i giocatori scelti (ora è async)
      await renderPlayerList();

      // Recupera il current event unit in modo sicuro
      const eventUnitId = await fetchCurrentEventUnit();
      window.event_unit_id = eventUnitId;
      
      // Funzione per navigare alla pagina di aggiunta giocatore
      function navigateToAddPlayer() {
        let url = `/aggiungi-giocatore.html?owner=${ownerId}&opponent=${opponentId}&contest=${contestId}&user=${userIdAttivo}`;
        if (window.event_unit_id) {
          url += `&event_unit_id=${window.event_unit_id}`;
        }
        window.location.href = url;
      }
      
      // Funzione per resettare la squadra
      function resetTeam() {
        if (confirm("Sei sicuro di voler cancellare tutti i giocatori selezionati?")) {
          saveChosenPlayers([]);
          renderPlayerList();
        }
      }
      
      // Funzione per confermare la squadra
      async function confirmSquad() {
        const players = loadChosenPlayers();
        if (!players.length) {
          alert("Devi scegliere almeno un giocatore!");
          return;
        }
        const bodyObj = {
          contestId,
          userId: userIdAttivo,
          players
        };
        try {
          const resp = await fetch("/confirm-squad", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(bodyObj)
          });
          if(!resp.ok) {
            const err = await resp.json();
            alert("Errore conferma squadra: " + err.error);
            return;
          }
          // Ok
          window.location.href = `/user-landing.html?user=${userIdAttivo}`;
        } catch(e) {
          alert("Errore di rete");
          console.error(e);
        }
      }
      
      // Aggiungi listener ai pulsanti del footer
      const addPlayerFooterBtnEl = document.getElementById("addPlayerFooterBtn");
      if (addPlayerFooterBtnEl) {
        addPlayerFooterBtnEl.addEventListener("click", navigateToAddPlayer);
      }
      
      // Aggiungi listener al nuovo pulsante FAB per aggiungere giocatore
      const addPlayerBtnEl = document.getElementById("addPlayerBtn");
      if (addPlayerBtnEl) {
        addPlayerBtnEl.addEventListener("click", navigateToAddPlayer);
      }
      
      // Aggiungi listener al pulsante RESET TEAM
      const resetTeamBtnEl = document.getElementById("resetTeamBtn");
      if (resetTeamBtnEl) {
        resetTeamBtnEl.addEventListener("click", resetTeam);
      }
      
      // Aggiungi listener al pulsante CONFIRM
      const confirmFooterBtnEl = document.getElementById("confirmFooterBtn");
      if (confirmFooterBtnEl) {
        confirmFooterBtnEl.addEventListener("click", confirmSquad);
      }
    });
  </script>
</body>
</html>
