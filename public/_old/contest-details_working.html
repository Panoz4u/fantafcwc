<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Contest Details - Fanteex</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Header principale -->
  <header class="details-header">
    <div class="cd-left-side">
      <div class="back-arrow" id="backArrow">&#8592;</div>
      <div class="match-title">MATCH DETAILS</div>
    </div>
    <div class="teex-container" id="teexContainer">Teex: 463.00</div>
  </header>

  <!-- Header secondario: 3 blocchi (utente corrente, stato+stake, avversario) -->
  <section class="contest-header-layout" id="contestHeader">
    <!-- Blocco sinistro: Utente corrente -->
    <div class="side-block" id="leftSide">
      <div class="user-block-left">
        <img id="leftAvatar" class="avatar-60" src="avatars/default.png" alt="User Avatar">
        <div class="left-text-block">
          <span id="leftUsername" class="user-name-left">USERNAME</span>
        </div>
      </div>
      <div class="left-cost" id="leftCost">0.0</div>
    </div>

    <!-- Blocco centrale: Stato e Stake -->
    <div class="center-block">
      <div class="status-rect" id="statusRect">READY</div>
      <div class="stake-value" id="stakeValue">0.0</div>
    </div>

    <!-- Blocco destro: Avversario -->
    <div class="side-block" id="rightSide">
      <div class="user-block-right">
        <div class="right-text-block">
          <span id="rightUsername" class="user-name-right">OPPONENT</span>
        </div>
        <img id="rightAvatar" class="avatar-60" src="avatars/default.png" alt="Opponent Avatar">
      </div>
      <div class="right-cost" id="rightCost">0.0</div>
    </div>
  </section>

  <!-- Sezione Teams: Liste dei giocatori -->
  <section class="teams-section">
    <!-- Lista Squadra Sinistra (utente corrente) -->
    <div class="team-container left-team" id="leftTeamContainer">
      <div class="team-list" id="leftTeamList">
        <!-- I giocatori verranno renderizzati qui -->
      </div>
    </div>
    <!-- Lista Squadra Destra (avversario) -->
    <div class="team-container right-team" id="rightTeamContainer">
      <div class="team-list" id="rightTeamList">
        <!-- I giocatori verranno renderizzati qui -->
      </div>
    </div>
  </section>

  <script>
    // Legge i parametri dalla query string
    const params = new URLSearchParams(window.location.search);
    const contestId = params.get("contest");
    const currentUserId = params.get("user");
    const eventUnitId = params.get("event_unit_id");

    // Carica il Teex balance
    async function loadTeexBalance() {
      try {
        const resp = await fetch("/user-landing-info?user=" + currentUserId);
        if (resp.ok) {
          const data = await resp.json();
          document.getElementById("teexContainer").textContent = "Teex: " + data.user.teex_balance;
        } else {
          document.getElementById("teexContainer").textContent = "Teex: 0";
        }
      } catch (error) {
        console.error("Error loading teex balance:", error);
        document.getElementById("teexContainer").textContent = "Teex: 0";
      }
    }

    // Click sulla freccia torna alla landing
    document.getElementById("backArrow").addEventListener("click", () => {
      window.location.href = "/user-landing.html?user=" + currentUserId;
    });

    // Carica i dettagli del contest
    async function loadContestDetails() {
      if (!contestId || !currentUserId) {
        alert("Missing contest or user parameter!");
        return;
      }
      try {
        const resp = await fetch(`/contest-details?contest=${contestId}&user=${currentUserId}&event_unit_id=${eventUnitId}`);
        if (!resp.ok) {
          document.body.innerHTML = "<h1>Error loading contest details!</h1>";
          return;
        }
        const data = await resp.json();
        // Popola l'header secondario con i dati degli utenti
        populateHeader(data.contest);
        // Renderizza le liste dei giocatori
        renderTeamLists(data.ownerTeam, data.opponentTeam, data.contest);
      } catch (error) {
        console.error("Error loading contest details", error);
        document.body.innerHTML = "<h1>Error loading contest details!</h1>";
      }
    }


      // Funzione ausiliaria per ottenere la sorgente corretta dell'avatar
        function getAvatarSrc(avatar) {
          if (avatar) {
            if (avatar.startsWith("http")) {
              return avatar;
            } else {
              return "avatars/" + avatar;
            }
          } else {
            return "avatars/avatar.jpg";
          }
        }
    // Popola l'header secondario in base al contest
    function populateHeader(contestData) {
    const iAmOwner = (parseInt(currentUserId) === parseInt(contestData.owner_id));
    if (iAmOwner) {
      document.getElementById("leftAvatar").src = getAvatarSrc(contestData.owner_avatar);
      document.getElementById("leftUsername").textContent = contestData.owner_name;
      document.getElementById("leftCost").textContent = contestData.owner_cost || "0.0";

      document.getElementById("rightAvatar").src = getAvatarSrc(contestData.opponent_avatar);
      document.getElementById("rightUsername").textContent = contestData.opponent_name;
      document.getElementById("rightCost").textContent = contestData.opponent_cost || "0.0";
    } else {
      document.getElementById("leftAvatar").src = getAvatarSrc(contestData.opponent_avatar);
      document.getElementById("leftUsername").textContent = contestData.opponent_name;
      document.getElementById("leftCost").textContent = contestData.opponent_cost || "0.0";

      document.getElementById("rightAvatar").src = getAvatarSrc(contestData.owner_avatar);
      document.getElementById("rightUsername").textContent = contestData.owner_name;
      document.getElementById("rightCost").textContent = contestData.owner_cost || "0.0";
    }
    document.getElementById("statusRect").textContent = contestData.status_display || "READY";
    document.getElementById("stakeValue").textContent = contestData.stake || "0.0";
  }

    // Renderizza le liste dei giocatori per ciascuna squadra
    function renderTeamLists(ownerTeam, opponentTeam, contestData) {
      const leftTeamList = document.getElementById("leftTeamList");
      const rightTeamList = document.getElementById("rightTeamList");
      leftTeamList.innerHTML = "";
      rightTeamList.innerHTML = "";

      // Determina se il current user è owner
      const isCurrentUserOwner = (parseInt(currentUserId) === parseInt(contestData.owner_id));

      if (isCurrentUserOwner) {
        // Se current user è owner, usa ownerTeam per la lista di sinistra e opponentTeam per quella di destra
        ownerTeam.forEach(player => {
          leftTeamList.appendChild(createPlayerRow(player, "left"));
        });
        opponentTeam.forEach(player => {
          rightTeamList.appendChild(createPlayerRow(player, "right"));
        });
      } else {
        // Se current user è opponent, inverte le liste
        opponentTeam.forEach(player => {
          leftTeamList.appendChild(createPlayerRow(player, "left"));
        });
        ownerTeam.forEach(player => {
          rightTeamList.appendChild(createPlayerRow(player, "right"));
        });
      }
    }

    // Crea una riga per un giocatore.
    // Il parametro "side" determina l'ordine dei blocchi: "left" per il current user, "right" per l'avversario (speculare).
    function createPlayerRow(player, side) {
      // Crea il container per la riga
      const row = document.createElement("div");
      row.classList.add("player-row");

      // BLOCCO A: Icona e posizione
      const blockA = document.createElement("div");
      blockA.classList.add("block-a");
      const iconImg = document.createElement("img");
      iconImg.classList.add("player-icon");
      iconImg.src = player.picture ? `pictures/${player.picture}` : `pictures/player_placeholder.png`;
      iconImg.onerror = function() {
        this.src = 'pictures/player_placeholder.png';
      };
      const posBadge = document.createElement("div");
      posBadge.classList.add("position-badge");
      posBadge.textContent = player.position;
      // Color coding per posizione
      if (player.position === "P") posBadge.style.backgroundColor = "#FFD600";
      else if (player.position === "D") posBadge.style.backgroundColor = "#00FF7F";
      else if (player.position === "C") posBadge.style.backgroundColor = "#00BFFF";
      else if (player.position === "A") posBadge.style.backgroundColor = "#FF4500";
      blockA.appendChild(iconImg);
      blockA.appendChild(posBadge);

      // BLOCCO B: Nome e match info
      const blockB = document.createElement("div");
      blockB.classList.add("block-b");
      const nameSpan = document.createElement("span");
      nameSpan.classList.add("player-shortname");
      nameSpan.textContent = player.athlete_shortname;
      
      // Creiamo il match info con il team del giocatore in grassetto e bianco, l'altro in grigio
      const matchSpan = document.createElement("span");
      matchSpan.classList.add("player-label");
      
      if (player.home_team_code && player.away_team_code) {
        // Determina se il giocatore è della squadra di casa o trasferta
        const playerTeamId = parseInt(player.team_id);
        const homeTeamId = parseInt(player.home_team);
        const awayTeamId = parseInt(player.away_team);
        
        const isHomeTeam = playerTeamId === homeTeamId;
        const isAwayTeam = playerTeamId === awayTeamId;
        
        // Crea il testo del match con il team del giocatore in grassetto e bianco, l'altro in grigio
        const homeSpan = document.createElement("span");
        if (isHomeTeam) {
          homeSpan.style.fontWeight = "bold";
          homeSpan.style.color = "white";
        } else {
          homeSpan.style.color = "#999999"; // Grigio
        }
        homeSpan.textContent = player.home_team_code;
        
        const dashSpan = document.createElement("span");
        dashSpan.textContent = "-";
        
        const awaySpan = document.createElement("span");
        if (isAwayTeam) {
          awaySpan.style.fontWeight = "bold";
          awaySpan.style.color = "white";
        } else {
          awaySpan.style.color = "#999999"; // Grigio
        }
        awaySpan.textContent = player.away_team_code;
        
        matchSpan.appendChild(homeSpan);
        matchSpan.appendChild(dashSpan);
        matchSpan.appendChild(awaySpan);
      } else {
        matchSpan.textContent = "PARTITA";
      }
      
      blockB.appendChild(nameSpan);
      blockB.appendChild(matchSpan);

      // BLOCCO C: Punteggio & Costo
      const blockC = document.createElement("div");
      blockC.classList.add("block-c");
      const pointsRect = document.createElement("div");
      pointsRect.classList.add("points-rect");
      // MODIFICA QUI: Se is_ended è 0, lascia vuoto, altrimenti mostra i punti
      if (parseInt(player.is_ended) === 0) {
        pointsRect.classList.add("not-ended");
        pointsRect.textContent = "";  // Lascia vuoto
      } else {
        pointsRect.textContent = parseFloat(player.athlete_points).toFixed(1);
      }
      const costText = document.createElement("div");
      costText.classList.add("player-cost-text");
      costText.textContent = parseFloat(player.cost || 0).toFixed(1);
      blockC.appendChild(pointsRect);
      blockC.appendChild(costText);


      // Ora, in base al lato, ordiniamo i blocchi:
      // Per il lato sinistro (current user): ordine A - B - C
      // Per il lato destro (avversario): ordine C - B - A (speculare)
      if (side === "left") {
        row.appendChild(blockA);
        row.appendChild(blockB);
        row.appendChild(blockC);
      } else {
        row.appendChild(blockC);
        row.appendChild(blockB);
        row.appendChild(blockA);
      }
      return row;
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadTeexBalance();
      loadContestDetails();
    });
  </script>
</body>
</html>
