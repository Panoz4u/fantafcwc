<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sfida Amico - Fanteex</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .opponent-list {
      margin-top: 20px;
      padding: 0 16px;
    }
    
    .opponent-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #1F2C4D;
    }
    
    .opponent-info {
      display: flex;
      align-items: center;
      flex: 1;
    }
    
    .opponent-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
    }
    
    .opponent-name {
      font-family: 'Barlow Condensed', sans-serif;
      font-size: 20px;
      color: white;
      text-transform: uppercase;
      margin: 0;
    }
    
    .progress-wrapper {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    
    .progress-bar-container {
      width: 120px;
      height: 6px;
      background-color: #333;
      border-radius: 3px;
      overflow: hidden;
      margin-right: 8px;
    }
    
    .progress-bar-fill {
      height: 100%;
      background-color: #FF00C8;
      width: 35%;
    }
    
    .progress-text {
      font-size: 14px;
      color: #FF00C8;
      font-family: 'Montserrat', sans-serif;
      font-weight: 800;
    }
    
    .search-container {
      background-color: #131A47;
      border-radius: 25px;
      padding: 10px 15px;
      margin: 20px 16px;
      display: flex;
      align-items: center;
    }
    
    .search-input {
      background: transparent;
      border: none;
      color: white;
      width: 100%;
      padding: 5px;
      font-family: 'Montserrat', sans-serif;
      outline: none;
    }
    
    .search-input::placeholder {
      color: #8E8E8E;
    }
    
    
    /* Modificato l'header per posizionare correttamente il titolo */
    .cd-top-header {
      position: relative;
    }
    
    .cd-left-side {
      position: relative;
    }
    
    .back-arrow {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
    }
    
    .header-title-left {
      margin-left: 30px; /* Spazio per la freccia */
    }
  </style>
</head>
<body>
  <!-- Header con freccia indietro, titolo e teex balance -->
  <div class="cd-top-header">
    <div class="cd-left-side">
      <a href="javascript:history.back()" class="back-arrow">←</a>
      <h1 class="header-title-left">SFIDA AMICO</h1>
    </div>
    <div class="teex-container" id="teexContainer">
      <img src="icons/teex.png" alt="Teex" class="teex-icon">
      <span id="teexBalance">0</span>
    </div>
  </div>
  
  <!-- Search box -->
  <div class="search-container">
    <input type="text" id="searchInput" class="search-input" placeholder="Search by name">
  </div>
  
  <!-- Lista degli utenti -->
  <div class="opponent-list" id="opponentList">
    <!-- Gli utenti verranno inseriti qui dinamicamente -->
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    // 'owner' = l'owner user
    const ownerId = params.get("owner");
    // 'user' = userIdCorrente (lo stesso in questo scenario)
    const currentUser = params.get("user");
    const eventUnitId = params.get("event_unit_id"); // Nuovo parametro
    
    // Funzione per gestire correttamente gli avatar
    function getAvatarUrl(avatarPath) {
      if (!avatarPath) {
        return "avatars/avatar.jpg"; // Avatar di default
      }
      
      // Controlla se è già un URL completo (inizia con http o https)
      if (avatarPath.startsWith('http://') || avatarPath.startsWith('https://')) {
        return avatarPath;
      }
      
      // Altrimenti è un nome file, aggiungi il percorso avatars/
      return `avatars/${avatarPath}`;
    }
    
    window.addEventListener("DOMContentLoaded", async () => {
      if (!ownerId) {
        alert("owner mancante!");
        window.location.href = "/index.html";
        return;
      }
      
      // Carica il saldo Teex dell'utente
      try {
        const userResp = await fetch(`/user-landing-info?user=${currentUser}`);
        const userData = await userResp.json();
        document.getElementById("teexBalance").textContent = userData.user.teex_balance.toLocaleString();
      } catch(e) {
        console.error("Errore nel recupero dei dati utente", e);
      }
      
      // Carica tutti gli utenti
      try {
        const resp = await fetch("/users");
        const allUsers = await resp.json();
        const opponents = allUsers.filter(u => u.user_id != ownerId);
        
        // Ordina gli utenti per username
        opponents.sort((a, b) => a.username.localeCompare(b.username));
        
        renderOpponentList(opponents);
        
        // Aggiungi funzionalità di ricerca - versione alternativa
        document.getElementById("searchInput").addEventListener("input", function() {
          const searchTerm = this.value.toLowerCase().trim();
          
          // Se il campo di ricerca è vuoto, mostra tutti gli utenti
          if (searchTerm === "") {
            renderOpponentList(opponents);
            return;
          }
          
          // Filtra gli utenti il cui nome contiene il termine di ricerca
          const filteredOpponents = [];
          for (const user of opponents) {
            if (user.username.toLowerCase().indexOf(searchTerm) !== -1 || 
                (user.email && user.email.toLowerCase().indexOf(searchTerm) !== -1)) {
              filteredOpponents.push(user);
            }
          }
          
          renderOpponentList(filteredOpponents);
        });
      } catch(e) {
        console.error("Errore fetch /users", e);
      }
    });
    
    function renderOpponentList(opponents) {
      const opponentList = document.getElementById("opponentList");
      opponentList.innerHTML = "";
      
      if (opponents.length === 0) {
        opponentList.innerHTML = "<p style='text-align: center; color: #ccc;'>Nessun utente trovato</p>";
        return;
      }
      
      opponents.forEach(user => {
        const opponentItem = document.createElement("div");
        opponentItem.className = "opponent-item";
        
        // Usa la funzione getAvatarUrl per gestire correttamente gli avatar
        const avatarSrc = getAvatarUrl(user.avatar);
        
        opponentItem.innerHTML = `
          <div class="opponent-info">
            <img src="${avatarSrc}" alt="${user.username}" class="opponent-avatar">
            <div>
              <h3 class="opponent-name">${user.username}</h3>
              <div class="progress-wrapper">
                <div class="progress-bar-container">
                  <div class="progress-bar-fill"></div>
                </div>
                <span class="progress-text">35%</span>
              </div>
            </div>
          </div>
          <button class="play-contest-button" data-id="${user.user_id}">PLAY</button>
        `;
        
        opponentList.appendChild(opponentItem);
      });
      
      // Aggiungi event listener ai pulsanti PLAY
      document.querySelectorAll(".play-contest-button").forEach(button => {
        button.addEventListener("click", async () => {
          const oppId = button.getAttribute("data-id");
          try {
            const resp = await fetch("/contests", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                owner: ownerId,
                opponent: oppId,
                event_unit_id: eventUnitId
              })
            });
            if (!resp.ok) {
              const err = await resp.json();
              alert("Errore creazione contest: " + err.error);
              return;
            }
            const data = await resp.json(); // contestId
            window.location.href = `/riassunto.html?owner=${ownerId}&opponent=${oppId}&contest=${data.contestId}&user=${currentUser}&event_unit_id=${eventUnitId}`;
          } catch (e) {
            console.error("Errore POST /contests", e);
            alert("Impossibile creare contest");
          }
        });
      });
    }
  </script>
</body>
</html>
