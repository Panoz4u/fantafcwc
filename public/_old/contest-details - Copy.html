<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Contest Details - Fanteex</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,800;1,800&family=Barlow+Condensed:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">

</head>

<body>
  <!-- Header -->
  <header class="details-header">
    <div class="back-arrow" id="backArrow">&#8592;</div>
    <h1 class="details-title">Match Details</h1>
    <div class="teex-container details-teex">
      <img src="icons/teex.png" alt="Teex" class="teex-icon">
      <span id="teexBalance">Teex: ???</span>
    </div>
  </header>



<!-- Contest Summary -->
<section class="contest-summary">
  <!-- Left Player -->
  <div class="player-info left-player" id="leftPlayer">
    <div class="player-inline">
      <img class="player-avatar" src="avatars/default.png" alt="Player Avatar">
      <div class="player-text">
        <span class="player-name left-name" id="leftName">PLAYER</span>
        <span class="player-cost" id="leftCost">0.0</span>
      </div>
    </div>
  </div>

  <!-- Center Block -->
  <div class="center-info">
    <div class="center-status" id="contestStatusHeader">READY</div>
    <div class="stake-container">
      <span class="stake-value" id="stakeValue">0.0</span>
    </div>
  </div>

  <!-- Right Player -->
  <div class="player-info right-player" id="rightPlayer">
    <div class="player-inline">
      <div class="player-text">
        <span class="player-name right-name" id="rightName">PLAYER</span>
        <span class="player-cost" id="rightCost">0.0</span>
      </div>
      <img class="player-avatar" src="avatars/default.png" alt="Player Avatar">
    </div>
  </div>
</section>


  <!-- Play your SUBIN Button -->
  <button class="play-button" id="playButton">
    <img src="icons/coin_green.png" alt="Coin" class="button-icon">
    Play your SUBIN
  </button>

  <!-- Teams Section -->
  <section class="teams-section">
    <!-- Left Team List: le 3 sottocomponenti in orizzontale -->
    <div class="team-container left-team" id="leftTeamContainer">
      <div class="team-list" id="leftTeamList">
        <!-- Left team players will be rendered here -->
      </div>
    </div>
    <!-- Right Team List: ordine speculare in orizzontale -->
    <div class="team-container right-team" id="rightTeamContainer">
      <div class="team-list" id="rightTeamList">
        <!-- Right team players will be rendered here -->
      </div>
    </div>
  </section>

  <script>
    const params = new URLSearchParams(window.location.search);
    const contestId = params.get("contest");
    const userId = params.get("user");
    const currentUser = params.get("user"); // Current user passed in URL

    document.addEventListener("DOMContentLoaded", loadDetails);

    async function loadDetails() {
      if (!contestId || !currentUser) {
        alert("Missing contest or user parameter!");
        return;
      }
      try {
        const resp = await fetch(`/contest-details?contest=${contestId}`);
        if (!resp.ok) {
          document.body.innerHTML = "<h1>Error loading contest details!</h1>";
          return;
        }
        const data = await resp.json();
        renderContestDetails(data.contest, data.ownerTeam, data.opponentTeam);
      } catch (e) {
        console.error("Error loading contest details", e);
        document.body.innerHTML = "<h1>Error loading contest details!</h1>";
      }
    }

     async function loadTeexBalance() {
        const resp = await fetch(`/user-landing-info?user=${userId}`);
        if (resp.ok) {
          const data = await resp.json();
          document.getElementById("teexBalance").textContent = `Teex: ${data.user.teex_balance}`;
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        loadTeexBalance();
        loadContestDetails();
      });

    
    function renderContestDetails(contestData, ownerTeam, opponentTeam) {
      const iAmOwner = parseInt(userId) === parseInt(contestData.owner_id);
      const isCurrentOwner = parseInt(currentUser) === parseInt(contestData.owner_id);
      let leftData, rightData;
      // INVERTIAMO le variabili rispetto all'ordine DB per garantire che il current user sia sempre a sinistra.
      if (isCurrentOwner) {
        // Se il current user è owner, allora nella query il DB restituisce owner_cost e opponent_cost, ma il risultato è invertito.
        // Quindi impostiamo leftData con il valore che (in landing) rappresenta il current user's score:
        leftData = {
          name: contestData.owner_name,
          avatar: contestData.owner_avatar,
          // Invertiamo: se nel DB owner_cost è il punteggio dell'avversario, usiamo opponent_cost per current user
          cost: contestData.opponent_cost
        };
        rightData = {
          name: contestData.opponent_name,
          avatar: contestData.opponent_avatar,
          cost: contestData.owner_cost
        };
      } else {
        // Se il current user è opponent, lasciamo l'ordine: current user's score = opponent_cost
        leftData = {
          name: contestData.opponent_name,
          avatar: contestData.opponent_avatar,
          cost: contestData.opponent_cost
        };
        rightData = {
          name: contestData.owner_name,
          avatar: contestData.owner_avatar,
          cost: contestData.owner_cost
        };
      }

      // Header: mostra current user's info a sinistra
      const leftPlayer = document.getElementById("leftPlayer");
      leftPlayer.querySelector(".player-avatar").src = `avatars/${leftData.avatar}`;
      leftPlayer.querySelector("#leftName").textContent = leftData.name;
      leftPlayer.querySelector("#leftCost").textContent = parseFloat(leftData.cost).toFixed(1);

      const rightPlayer = document.getElementById("rightPlayer");
      rightPlayer.querySelector("#rightName").textContent = rightData.name;
      rightPlayer.querySelector(".player-avatar").src = `avatars/${rightData.avatar}`;
      rightPlayer.querySelector("#rightCost").textContent = parseFloat(rightData.cost).toFixed(1);

      // Center Block
      document.getElementById("contestStatusHeader").textContent = contestData.status_display;
      document.getElementById("stakeValue").textContent = parseFloat(contestData.stake).toFixed(1);

      // Teex: assume teexBalance already set via user-landing (o eventualmente da una query globale)

      // Render team lists:
      // Left team: order: Avatar/pos, then Name/PARTITA, then Points/Cost (all in row)
      renderTeamPlayersLeft(iAmOwner ? ownerTeam : opponentTeam, "leftTeamList");
      // Right team: order (speculare): Points/Cost, then Name/PARTITA, then Avatar/pos
      renderTeamPlayersRight(iAmOwner ? opponentTeam : ownerTeam, "rightTeamList");
    }

    function renderTeamPlayersLeft(teamData, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      if (!teamData || !teamData.length) {
        container.innerHTML = "<p>No players</p>";
        return;
      }
      teamData.forEach(player => {
        // Create a row in horizontal layout
        const row = document.createElement("div");
        row.classList.add("player-row-left");
        /* Left team order:
           1. Avatar with badge (badge in top-right, reduced)
           2. Name container (athlete_shortname and subtitle "PARTITA")
           3. Info container: points and cost (aligned horizontally)
        */
        const avatarContainer = document.createElement("div");
        avatarContainer.classList.add("avatar-container-left");
        const avatarImg = document.createElement("img");
        avatarImg.classList.add("player-avatar-small");
        avatarImg.src = player.picture ? `pictures/${player.picture}` : `pictures/silouette.jpg`;
        avatarContainer.appendChild(avatarImg);
        const badge = document.createElement("div");
        badge.classList.add("position-badge-left");
        badge.textContent = player.position;
        // Set color based on position
        if (player.position === "P") badge.style.backgroundColor = "#FFD600";
        else if (player.position === "D") badge.style.backgroundColor = "#00FF7F";
        else if (player.position === "C") badge.style.backgroundColor = "#00BFFF";
        else if (player.position === "A") badge.style.backgroundColor = "#FF4500";
        avatarContainer.appendChild(badge);

        const nameContainer = document.createElement("div");
        nameContainer.classList.add("name-container");
        const nameSpan = document.createElement("div");
        nameSpan.classList.add("player-shortname");
        nameSpan.textContent = player.athlete_shortname;
        const subtitle = document.createElement("div");
        subtitle.classList.add("player-subtitle");
        subtitle.textContent = "PARTITA";
        nameContainer.appendChild(nameSpan);
        nameContainer.appendChild(subtitle);

        const infoContainer = document.createElement("div");
        infoContainer.classList.add("info-container");
        const pointsCell = document.createElement("div");
        pointsCell.classList.add("points-cell");
        if (player.is_ended == 0) {
          pointsCell.textContent = "";
          pointsCell.classList.add("not-ended");
        } else {
          pointsCell.textContent = parseFloat(player.athlete_points).toFixed(1);
          pointsCell.classList.add("ended");
        }
        const costCell = document.createElement("div");
        costCell.classList.add("cost-cell");
        costCell.textContent = parseFloat(player.cost).toFixed(1);
        infoContainer.appendChild(pointsCell);
        infoContainer.appendChild(costCell);

        row.appendChild(avatarContainer);
        row.appendChild(nameContainer);
        row.appendChild(infoContainer);

        container.appendChild(row);
      });
    }

    function renderTeamPlayersRight(teamData, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      if (!teamData || !teamData.length) {
        container.innerHTML = "<p>No players</p>";
        return;
      }
      teamData.forEach(player => {
        // Right team order (speculare):
        // 1. Info container: points and cost
        // 2. Name container: athlete_shortname and subtitle "PARTITA"
        // 3. Avatar with badge (badge in top-left)
        const row = document.createElement("div");
        row.classList.add("player-row-right");
        const infoContainer = document.createElement("div");
        infoContainer.classList.add("info-container-right");
        const pointsCell = document.createElement("div");
        pointsCell.classList.add("points-cell");
        if (player.is_ended == 0) {
          pointsCell.textContent = "";
          pointsCell.classList.add("not-ended");
        } else {
          pointsCell.textContent = parseFloat(player.athlete_points).toFixed(1);
          pointsCell.classList.add("ended");
        }
        const costCell = document.createElement("div");
        costCell.classList.add("cost-cell");
        costCell.textContent = parseFloat(player.cost).toFixed(1);
        infoContainer.appendChild(pointsCell);
        infoContainer.appendChild(costCell);

        const nameContainer = document.createElement("div");
        nameContainer.classList.add("name-container-right");
        const nameSpan = document.createElement("div");
        nameSpan.classList.add("player-shortname");
        nameSpan.textContent = player.athlete_shortname;
        const subtitle = document.createElement("div");
        subtitle.classList.add("player-subtitle");
        subtitle.textContent = "PARTITA";
        nameContainer.appendChild(nameSpan);
        nameContainer.appendChild(subtitle);

        const avatarContainer = document.createElement("div");
        avatarContainer.classList.add("avatar-container-right");
        const avatarImg = document.createElement("img");
        avatarImg.classList.add("player-avatar-small");
        avatarImg.src = player.picture ? `pictures/${player.picture}` : `pictures/silouette.jpg`;
        avatarContainer.appendChild(avatarImg);
        const badge = document.createElement("div");
        badge.classList.add("position-badge-right");
        badge.textContent = player.position;
        if (player.position === "P") badge.style.backgroundColor = "#FFD600";
        else if (player.position === "D") badge.style.backgroundColor = "#00FF7F";
        else if (player.position === "C") badge.style.backgroundColor = "#00BFFF";
        else if (player.position === "A") badge.style.backgroundColor = "#FF4500";
        avatarContainer.appendChild(badge);

        row.appendChild(infoContainer);
        row.appendChild(nameContainer);
        row.appendChild(avatarContainer);

        container.appendChild(row);
      });
    }

    // Back arrow event
    document.getElementById("backArrow").addEventListener("click", () => {
      window.location.href = `/user-landing.html?user=${userId}`;
    });

    // "Play your SUBIN" button event
    document.getElementById("playButton").addEventListener("click", () => {
      alert("Play your SUBIN is inactive for now.");
    });
  </script>
</body>
</html>
